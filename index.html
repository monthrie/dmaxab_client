<html>
<head>
    <script type="text/javascript" src="mds.js"></script>
    <script type="text/javascript" src="service.js"></script>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <title>Add Entry</title>
    <style>
        /* Styles for the entire body */
        body {
            background-color: #f2f2f2;  /* Changed to a light gray color */
            display: flex; /* Keep as flex */
            flex-direction: column;  /* Changed to column to have all elements vertically */
            align-items: center;  /* Center items horizontally */
            padding: 20px; /* Keep padding */
            font-family: Arial, sans-serif;  /* Changed font to Arial */
        }
        /* Styles for the user info section */
        #user-info {
            width: 100%;  /* User info takes up full width */
            padding: 20px;  /* Add some padding inside the user info section */
            background-color: #fff;  /* User info has a white background */
            border-radius: 5px;  /* Rounded corners for the user info section */
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);  /* Subtle shadow for the user info section */
            margin-bottom: 20px; /* Add some space below the user info section */
        }
        /* Styles for the table */
        table {
            width: 100%; /* Table takes up full width */
            border-collapse: collapse; /* Keep as collapse */
            margin-bottom: 20px; /* Add some space below the table */
        }
        th, td {
            border: 1px solid #ddd;  /* Changed border color to a light gray */
            padding: 10px;  /* Increased padding for more space */
            text-align: left;  /* Left-aligned text looks more professional */
        }
        td.max {
            border: 1px solid #ddd;  /* Changed border color to a light gray */
            padding: 10px;  /* Increased padding for more space */
            text-align: left;  /* Left-aligned text looks more professional */
            overflow: hidden;  /* Keep as is */
            text-overflow: ellipsis;  /* Keep as is */
            white-space: nowrap;  /* Keep as is */
            max-width: 150px; /* Keep as is */
        }
        /* Styles for the button */
        button {
            padding: 5px 10px; /* Add some space around the button text */
            cursor: pointer; /* Change the cursor to a hand when hovering over the button */
            background-color: #686868; /* Set button color to a grey */
            color: white; /* Set text color to white */
            border: none; /* Remove border */
            border-radius: 3px; /* Slightly round the corners */
        }
        button:hover {
            background-color: #007B9A; /* Darken the button color when hovered */
        }
    </style>
</head>
<body>
    <!-- Main title -->
    <h1>Maxima Name Service</h1>
    <!-- User info section -->
    <div id="user-info">
        <h2>Your Info</h2>
        <p>Maxima Name: <span id="user-maxima-name"></span></p>
        <p>Permanent Address Status: <span id="user-permanent-address-status"></span></p>
    </div>
    <!-- Table -->
    <table id="address-book">
        <thead>
            <tr>
                <th>Name</th>
                <th class="max">MAX#</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <div style="align-self: flex-start;">
        <button id="refresh-button">Update Address Book</button>
    </div>
    <!-- Add Entry Form title -->
    <h3>Add Your Own MAX#</h3>
    <!-- Add Entry Form -->
    <form id="entry-form">
        <label for="name">Name:</label><br>
        <input type="text" id="name" name="name"><br>
        <label for="max">MAX#:</label><br>
        <input type="text" id="max" name="max">
        <button id="add-max-button">Paste your MAX#</button><br>
        <input type="submit" value="Submit">
    </form>
    <div id="feedback"></div>
    <script type="text/javascript">

        // Wait for the HTML document to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {

        // Fetch and display user info
            getMaximaName(function(err, name) {
                if (err) {
                    MDS.log(err);
                    return;
                }
                document.getElementById('user-maxima-name').textContent = name;
            });

                // Fetch the user's public key and mls
                getPublicKey(function(err, publicKey) {
                        if (err) {
                            MDS.log(err);
                            return;
                        }

                getMLS(function(err, mls) {
                    if (err) {
                        MDS.log(err);
                        return;
                    }

                    // Construct the MAX# 
                    var maxAddress = createMaxAddress(publicKey, mls);

                    // Create the command string
                    var command = 'maxextra action:getaddress maxaddress:' + maxAddress;

                    // Run the command using mds.cmd
                    mds.cmd(command, function(err, response) {
                        if (err) {
                            MDS.log(err);
                            return;
                        }

                        // Check the 'success' field in the response.
                        var permanentAddressStatus = response.response.success ? 'True' : 'False';
                        document.getElementById('user-permanent-address-status').textContent = permanentAddressStatus;
                    });
                });
            });

/*            
            getPublicKey(function(err, publicKey) {
                if (err) {
                    MDS.log(err);
                    return;
                }

                getMLS(function(err, mls) {
                    if (err) {
                        MDS.log(err);
                        return;
                    }

                    const maxAddress = createMaxAddress(publicKey, mls);
                    document.getElementById('user-permanent-address').textContent = maxAddress;
                });
            });

            */

            StaticMLSStatus(function(err, hasMLS) {
                if (err) {
                    MDS.log(err);
                    return;
                }

                document.getElementById('user-permanent-address-status').textContent = hasMLS ? 'True' : 'False';
            });

            // Setup the form submission event handler
            document.getElementById('entry-form').addEventListener('submit', function(event) {
                event.preventDefault();
    
                // Get the user's input data
                const name = document.getElementById('name').value;
                const max = document.getElementById('max').value;
               
                // log the collected data
                MDS.log('name: ' + name + ' max: ' + max);

                // Construct the message data
                const message = {"type":"ADD_ADDRESS","data":{"name":name,"max":max}};
               
               //log the message data
                MDS.log('message: ' + JSON.stringify(message));
    
                // Send the Maxima message
                sendMessage(message, 'MAX#0x30819F300D06092A864886F70D010101050003818D00308189028181009BB7465C454425291EBC2A851A4852F8C1B02F7A173A15780B304E2DCA663CC69AF15CA39D21914F5C1C4D20BE1066A29446F1B6AC8BC7FE1AE466D7E672C9BFAB64BA35BEE30ED8217BDB95959EA1B4410C70EF348051642876A8E99138AFCF5933E6DB3DB3ADBB3D418DBFFF30675D8BBB1A534DC5EE03740801579A73A0D10203010001#MxG18HGG6FJ038614Y8CW46US6G20810K0070CD00Z83282G60G1C0ANS2ENGJEFBYJM2SCQFR3U3KBJNP1WS9B0KG1Z2QG5T68S6N2C15B2FD7WHV5VYCKBDW943QZJ9MCZ03ESQ0TDR86PEGUFRSGEJBANN91TY2RVPQTVQSUP26TNR399UE9PPJNS75HJFTM4DG2NZRUDWP06VQHHVQSGT9ZFV0SCZBZDY0A9BK96R7M4Q483GN2T04P30GM5C10608005FHRRH4@78.141.238.36:9001', function(response) {
                    MDS.log('Callback function called');
                    MDS.log('Message sent response: ' + JSON.stringify(response));
                    var feedbackText = document.createElement('div'); // Create a new div element
                        feedbackText.textContent = "Your data has been passed to the hub controller! If they accept your entry, it will appear here soon.";  // Set its text content
                        feedbackText.style.color = "green";  // Set its color to green
                        feedbackText.style.fontWeight = "bold";  // Set its font weight to bold
                        document.getElementById('feedback').appendChild(feedbackText);  // Append it to the #feedback element

                });
            });

            document.getElementById('add-max-button').addEventListener('click', function(event) {
             event.preventDefault();

                // Check if the user has a static MLS
                hasStaticMLS(function(hasMLS) {
                    if (hasMLS) {
                        // If they do, get the public key and MLS
                        getPublicKey(function(err, publicKey) {
                            if (err) {
                                MDS.log(err);
                                return;
                            }

                            getMLS(function(err, mls) {
                                if (err) {
                                    MDS.log(err);
                                    return;
                                }

                                // Create the MAX address and fill in the form
                                const maxAddress = createMaxAddress(publicKey, mls);
                                document.getElementById('max').value = maxAddress;
                                // log the collected data
                                MDS.log('max: ' + maxAddress);
                            });
                        });
                    } else {
                        MDS.log('User does not have a static MLS');
                    }
                });
            });


            // Setup the refresh button click event handler
            document.getElementById('refresh-button').addEventListener('click', function(event) {
                event.preventDefault();
                sendTableRequest();
            });
            
        });

    </script>
</body>
</html>